version: '3.7'

volumes:
  # Shared with your geoserver, if you ave one!
  geoserver_data:
    name: geoserver_data

networks:
  # This is a network we share with our reverse proxy
  proxy:
    name: proxy
    # Won't be created or destroyed with docker-compose up|down
    external: true

services:
  geowebcache:
    container_name: geowebcache
    image: wildsong/geoserver:2.21.1
    environment:
      ENABLE_JSONP: "true"
      GEOWEBCACHE_DATA_DIR: /geoserver/gwc
    networks:
      - proxy
    expose:
      - "8080"
    volumes:
      - geoserver_data:/geoserver
    labels:
      # Yes, I am using the wrong name, it's a long story.
      caddy: geoserver.${DOMAIN}
      caddy.reverse_proxy: "{{upstreams 8080}}"
      caddy.tls.protocols: "tls1.3"
      caddy.tls.dns: "cloudflare ${CLOUDFLARE_API_TOKEN}"
    restart: unless-stopped
